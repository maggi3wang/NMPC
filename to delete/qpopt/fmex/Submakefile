
MATLABDIR = $(top_builddir)/matlab
MEXDIR    = $(top_builddir)/fmex

MEXFILES  = precisionModule

MEXFILES_f90 = $(MEXFILES:%=%.f90)
MEXFILES_O   = $(MEXFILES:%=$(MEXDIR)/%.o)

OBJECTS      = $(MEXFILES_O)
#MEXOPTS     = -g -argcheck
MEXOPTS      = -g -fortran
#MEXOPTS     = -O

LIBBLAS   = $(LIBDIR)/libblas.a
LIBQPOPT  = $(LIBDIR)/libqpopt.a
MEXLIBS   = $(LIBQPOPT) $(LIBBLAS)

all: lpoptfmex qpoptfmex
install: install_mex
clean: mex_clean
veryclean: mex_veryclean
distclean: mex_veryclean

lpoptfmex: $(MEXFILES_O) $(MEXLIBS)
	@echo "Installing lpopt mex files in ${MEXDIR}"
	mex $(MEXOPTS)  $(MEXDIR)/lpoptfmex.F90 \
          -output $(MEXDIR)/lpoptfmex $(MEXFILES_O) $(MEXLIBS) $(FLIBS)
	mv $(MEXDIR)/lpoptfmex.mex* $(MATLABDIR)

qpoptfmex: $(MEXFILES_O) $(MEXLIBS)
	@echo "Installing qpopt mex files in ${MEXDIR}"
	mex $(MEXOPTS)  $(MEXDIR)/qpoptfmex.F90 \
          -output $(MEXDIR)/qpoptfmex $(MEXFILES_O) $(MEXLIBS) $(FLIBS)
	mv $(MEXDIR)/qpoptfmex.mex* $(MATLABDIR)

# If not commmented out, all files will be recompiled if the makefile
# changes.
$(OBJECTS): GNUmakefile

install_mex: lpoptfmex qpoptmex

mex_clean:
	-rm -f $(MEXDIR)/*.o
	-rm -f $(MEXDIR)/*.mod

mex_veryclean: mex_clean

# Use mex to compile the object files

$(MEXDIR)/%.o : $(MEXDIR)/%.c
	mex $(MEXOPTS) -c $< $@ -outdir $(MEXDIR)

$(MEXDIR)/%.o : $(MEXDIR)/%.F90
	mex $(MEXOPTS) -c $< $@ -outdir $(MEXDIR)

# $@ target
# $< name of the first prerequisite (e.g., source file)
# -fmod=directory